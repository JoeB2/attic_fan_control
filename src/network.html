<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="file" content="set_bounds.html">
    <meta name="author" content="Joe Belson 20210822">
    <meta name="what" content="esp8266 html for WiFi connected temp/humidity bounds.">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtticFan Controller : Network Setup</title>
  </head>
  <body style="text-align: left;">
    <hr>
      <table class="calibrate"   id="settings" updated="0">
        <caption style="font-weight: bolder;padding-bottom:1rem">
          <h1>Set WiFi SSID & PWD & IP</h1>
        </caption>
          <thead>
              <tr>
                  <th>SSID</th>
                  <th>PWD</th>
              </tr>
          </thead>
          <tbody>
              <tr>
                  <td><input  id="ssid"   type="text"   name="cred"></td>
                  <td><input  id="pwd"    type="text"   name="cred"></td>
                  <td><input  id="submit" type="submit" onclick="f_submit()"></td>
              </tr>
          </tbody></table>


      <br>
      <label for="dhcp">DHCP:</label>
        <input type="checkbox" id="isDhcp" onclick="f_dhcp(this.checked)">
      <br><br>

      <label for="ip"   name="dhcp">IP:     </label><input id="ip"    type="text" name="dhcp" style="width: 7rem;">
      <label for="gw"   name="dhcp">Gateway:</label><input id="gw"    type="text" name="dhcp" style="width: 7rem;">
      <label for="mask" name="dhcp">Mask:   </label><input id="mask"  type="text" name="dhcp" style="width: 7rem;">
    </body>
    <script language = "javascript" type = "text/javascript">
  
        let webSock       = new WebSocket("ws://" + window.location.hostname + ":80?source=wifi");
        webSock.onopen    = function(evt){webSock.send('{"json":' + ping_network + '}');};
        webSock.onmessage = function(evt){f_webSockOnMessage(evt);}
        webSock.onerror   = function(evt){f_webSockOnError(evt);}
  
        const empty          = 0  // 0b00000000
            , readings       = 1  // 0b00000001
            , settings       = 2  // 0b00000010
            , net            = 4  // 0b00000100
            , atticEpochTime = 9  // 0b00001001
            , fanOnMs        = 17 // 0b00010001
            , systemEnabled  = 33 // 0b00100001
            , ping_readings  = 65 // 0b01000001
            , ping_settings  = 66 // 0b01000010
            , ping_network   = 68 // 0b01000100

        ;

        let j = {
              json : net
            , ssid : "ssid"
            , pwd : "pwd"
            , isDHCP : 1
            , ip : "11.1.1.11"
            , gw : "11.1.1.254"
            , mask : "255.255.255.0"
          };

        function f_webSockOnMessage(evt){
          if(document.getElementById("settings").getAttribute("updated")=="1")return;
          if(typeof evt.data === "string"){
              const j=JSON.parse(evt.data);
              if(j.json != net)return;
              for(key in j){
                if(key == "json")continue;
                dv = document.getElementById(key);
                switch(key){
                  case "ssid":dv.value = j.ssid;break;
                  case "isDhcp":f_dhcp(j.isDHCP);break;
                  case "ip":dv.value = j.ip;break;
                  case "gw":dv.value = j.gw;break;
                  case "mask":dv.value = j.mask;break;
                }
              }
          }document.getElementById("settings").setAttribute("updated", "1");
        }
        function f_webSockOnError(evt){}
        function f_submit(){
          for(var key in j){
            if(key == "json")continue;
            if(key=="isDHCP")
              j[key]=document.getElementById(key).checked;
            else j[key]=document.getElementById(key).value;
          }
          j.json = net;
          webSock.send(JSON.stringify(j));
          document.getElement.getElementById("title").setAttribute("updated", "0");
        }
        function f_dhcp(){
          chk = arguments[0];console.log(chk);
          document.getElementById("isDhcp").checked = chk;
          const n = document.getElementsByName("dhcp");
          if(chk){
            for(var i=0;i<n.length;i++)
              n[i].setAttribute("hidden", "hidden");
          }else{
            for(var i=0;i<n.length;i++)
              n[i].removeAttribute("hidden");
          }
       }
     </script>
  </html>
