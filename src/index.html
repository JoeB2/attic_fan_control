<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            rel="stylesheet"
            href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
            integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
            crossorigin="anonymous"
        />
        <title>AtticFan Controller : Readings</title>
        <style>
            html {
                font-family: Arial;
                display: inline-block;
                margin: 0px auto;
                text-align: left;
            }
            h2 {
                font-size: 2rem;
                text-align: center;
            }
            h3 {
                font-size: 2rem;
                text-align: center;
            }
            .units {
                font-size: 1.0rem;
            }
            input[type=button]{
                text-align: center;

                font-weight: bold;
                cursor: pointer;
                box-shadow: inset 1px 1px 1px rgba(255, 255, 255, 0.6),
                    inset -1px -1px 1px rgba(0, 0, 0, 0.6);

            }
            input[type="submit"] {
                border: 0;
                line-height: 1.5;
                padding: 0 7px;
                font-size: 13px;
                text-align: center;

                font-weight: bold;
                cursor: pointer;
                box-shadow: inset 2px 2px 3px rgba(255, 255, 255, 0.6),
                    inset -2px -2px 3px rgba(0, 0, 0, 0.6);
                }
            .c1 {
                text-align: center;
                padding-left: 0rem;
                padding-right: 0rem;
                padding-top: 0rem;
                padding-bottom: 0rem;
                height: auto;
            }
            .c2 {
                text-align: center;
                padding-left: 5px;
                padding-right: 5px;
                padding-top: 0;
                padding-bottom: 0;
                height: 1rem;
                font-weight: bold;
                font-size: 17px;
                width: 3rem;
                height: 3rem;
            }
            .c3 {
                text-align: center;
                padding-left: 3px;
                padding-right: 3px;
                padding-top: 0rem;
                padding-bottom: 0rem;
                font-weight: bold;
                height: auto;
            }
            .c4 {
                width: 1rem;
                padding-left: 1rem;
                padding-right: 1rem;
                padding-top: 0rem;
                padding-bottom: 0rem;
                font-weight: bold;
                text-align: center;
                width: 3rem;
                height:2rem;
            }
            .c5 {
                text-align: center;
                padding-left: 1rem;
                padding-right: 1.5rem;
                padding-top: 0rem;
                padding-bottom: 0rem;
                font-size: smaller;
                font-weight: bolder;
                line-height: 1.5;
                height: auto;
            }
            .blink {
                animation: blinker 1.9s linear infinite;
                color: #a81a1a;
                font-size: 25px;
                font-weight: bold;
                font-family: Verdana;
                text-align: center;
                font-weight: bold;
                padding-left: 2rem;
                height: 1rem;
            }
            @keyframes blinker {
                99% {
                    opacity: 0;
                }
            }
            ul.no-bullets {
                list-style-type: none; /* Remove bullets */
                padding: 0; /* Remove padding */
                margin: 0; /* Remove margins */
            }
            .sensors-grid{
                display:grid;
                gap: 1.5rem;
                grid-template-columns:repeat(2, 1fr);
                padding-block:2rem;
                width: min(95%, 70rem);
                margin-inline: auto;
                font-size:21pt;
            }
        </style>
        <input id="bt_help" type="button" onclick="f_help()" value="Help" title="Hide/Show WebSock Messages"/>
        <title>Attic Fan Switch</title>
    </head>
    <body>
        <h2>ESP8266 Attic Fan Manager</h2>
        <h3 id="atticEpochTime" style="font-size: 170%; color: rgb(0, 4, 255) ; font-weight: bold">
                00:00:00
        </h3>
        <main class="sensors-grid">
        <article>
            <img src="https://img.icons8.com/color/30/000000/thermometer.png"/>
            <span>Attic Temp:</span>
            <span id="t1">%T1%</span>
            <sup class="units">&deg;F</sup>
        </article>
        <article>
            <img src="https://img.icons8.com/color/30/000000/thermometer.png"/>
            <span>Inside Temp:</span>
            <span id="t2">%T2%</span>
            <sup class="units">&deg;F</sup>
        </article>

        <article>
            <i class="fas fa-thermometer-half" style="color: #059e8a"></i>
            <span>Outside Temp:</span>
            <span id="t3">%T3%</span>
            <sup class="units">&deg;F</sup>
        </article>
        <article>
            <img src="https://img.icons8.com/external-justicon-blue-justicon/30/000000/external-barometer-science-justicon-blue-justicon.png"/>
            <span>Barometer</span>
            <span id="p3">%P3%</span>
            <sup class="units">Hg</sup>
        </article>

        <article>
            <i class="fas fa-tint" style="color:#00add6;"></i>
            <span>Humidity:</span>
            <span id="h3">%H3%</span>
            <sup class="units">%</sup>&nbsp&nbsp
        </article>
        <article>
            <img src="https://img.icons8.com/external-vitaliy-gorbachev-blue-vitaly-gorbachev/30/000000/external-thermometer-weather-vitaliy-gorbachev-blue-vitaly-gorbachev-5.png"/>
            <span>Dew Point:</span>
            <span id="dp3">%DP3%</span>
            <sup class="units">&degF</sup>&nbsp&nbsp
        </article>
        <article>
            <img src="https://img.icons8.com/office/30/000000/alps.png"/>
            <span>Density Altitude:</span>
            <span id="a3">%A3%</span>
            <sup class="units">ft</sup>&nbsp&nbsp
        </article>
        </main>
    
    <table>
        <th>
            <tr style="font-weight: bold;">
                <td class="c1"></td>
                <td class="c2">Fan</td>
                <td style="width: 10px;"></td>
                <td class="c3">System</td>
                <td class="c3">Fan On<br>Timer</td>
                <td class="c4">Minutes</td>
                <td class="blink" id="vcc0">Charge</td>
            </tr>
        </th>
        <tr>
            <td class="c1"></td>
            <td class="c2" id="fanOn"
                style=  "padding: 1 3px;
                        border-radius: 30%;
                        background-color: rgb(248, 113, 135);
                        box-shadow: inset 2px 2px 3px rgba(255, 255, 255, 0.6),
                    inset -2px -2px 3px rgba(0, 0, 0, 0.6);"
            >OFF</td>
            <td></td>
            <td class="c3" id="system"
                style="padding: 0 0px;
                        border-radius: 50%;
                        font-weight: bold;
                        box-shadow: inset 2px 2px 3px rgba(255, 255, 255, 0.6),
                    inset -2px -2px 3px rgba(0, 0, 0, 0.6);
                    cursor: pointer;"
                onclick="f_system('button', this.innerHTML=='STOP')"
                updated="0"

                title="Enable / Disable Fan Control System"
            >Enable</td>
            <td class="c4">
                <input
                type="button"
                value="+ 5mins"
                onclick="f_fanTimer('button', +5)"
                title="add 5 minutes to fan on override"
            />
            <input
                type="button"
                value="- 5mins"
                onclick="f_fanTimer('button', -5)"
                title="remove 5 minutes from fan on override"
                style="margin-top: 5px;width: 100%;"
            />
            </td>
            <td class="c5" style="vertical-align:top">
                <label id="fanOnMs" updated="0">0</label>
                <input
                    type="submit"
                    onclick="f_fanTimer('submit' ,-1)"
                    title="***OVERRIDE***&#x0a;  Turn on fan for&#x0a; specified minutes."
                    style="margin-top: 10px; height: 25px; ;background: rgb(57, 216, 110)"
                />
            </td>
            <td class="blink" id="vcc1">Remote Battery<br>
                <span id="vcc" class="units">3.00</span>
                <sup class="units" id="vcc2">vcc</sup>
            </td>
    </tr>
        <tr>
            <td class="c1"></td>
            <td class="c2"></td>
            <td></td>
            <td class="c3"></td>
            <td class="c4">
            </td>
            <td class="c5">
            </td>
        </tr>
    </table>
        <br/><br/>
        <div id="help" hidden="true">
            <input
                value="Set Controller Limits"
                type="button"
                onclick="f_redirect('settings')"
                style="background: rgb(155, 219, 149)"
            />
            <input
                value="Update WiFi settings"
                type="button"
                onclick="f_redirect('wifi')"
                style="background: orange;"
            />
            <input
                value="Firmware / Startup Settings"
                type="button"
                onclick="f_redirect('update')"
                style="background:rgb(249, 253, 0);color: red;"
            />
            <br><br>
            <p id="json1" style="font-weight: normal; font-size: 12pt"></p>
            <p id="json2" style="font-weight: normal; font-size: 12pt"></p>
        </div>
    </body>
    <script language="javascript" type="text/javascript">
        let webSock = new WebSocket("ws://" + window.location.hostname + ":80?json=1");
        webSock.onopen = function(){ 
            let json = {json:atticEpochTime,atticEpochTime:0};
            json.atticEpochTime = Math.floor(Date.now() / 1000);
            webSock.send(JSON.stringify(json));
        };
        webSock.onmessage = function(evt) {f_webSockOnMessage(evt);};
        webSock.onerror = function(evt) {console.warn(evt);};
        webSock.onclose = function(){ console.log("webSock Connection Closed.")};

        const empty          = 0  // 0b00000000
            , readings       = 1  // 0b00000001
            , settings       = 2  // 0b00000010
            , net            = 4  // 0b00000100
            , atticEpochTime = 9  // 0b00001001
            , fanOnMs        = 17 // 0b00010001
            , systemEnabled  = 33 // 0b00100001
            , ping_readings  = 65 // 0b01000001
            , ping_settings  = 66 // 0b01000010
            , ping_network   = 68 // 0b01000100

        ;

        let j = {
              json: readings
            , t1: 98.60
            , t2: 82.33
            , t3: 87.30
            , p3: 29.92
            , h3: 88
            , dp3: 75
            , a3: 994
            , vcc: 2.85
            , atticEpochTime: 1637713842
            , fanOn: 1
            , fanOnMs: 138000
            , systemEnabled: 1
        };
        function f_webSockOnMessage(evt){
            if (typeof evt.data === "string"){
                let s = evt.data;
                j = JSON.parse(s);
                for (let key in j){
                    document.getElementById("json2").innerHTML = s;
                    switch (key){
                        case "json": continue;
                          break;
                        case "vcc":
                            f_battery(j[key]);
                          break;
                        case "atticEpochTime":
                            const options = { hourCycle: 'h24', year: 'numeric', month: '2-digit', day: '2-digit'
                                            , hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short'
                                  };
                            const dt = new Date();
                            document.getElementById("atticEpochTime").innerHTML
                                = dt.toLocaleTimeString("en-US", options);
                                j[key]= dt.valueOf()/1000;
                          break;
                        case "fanOn":
                            f_fan(j[key]);
                          break;
                        case "fanOnMs":
                                f_fanTimer('ws', f_ms2min(j[key]));
                          break;
                        case "dp3":
                            document.getElementById(key).innerHTML = j.h3?j.dp3:"n/a";
                          break;
                        case "a3":
                            document.getElementById(key).innerHTML = j.h3?j.a3:"n/a";
                          break;
                        case "systemEnabled":
                            f_system("ws", j.systemEnabled);
                          break;
                        default:
                            document.getElementById(key).innerHTML =j[key];
                    }
                }
            }
        }
        function gHbi(e){return(document.getElementById(e).innerHTML);} // return innerHTML by id
        function sHbi(e,v){document.getElementById(e).innerHTML=v;}     // set value by id
        function gVAbi(e,a){return(document.getElementById(e).getAttribute("a"));} // get value by id
        function sVAbi(e,a,v){document.getElementById(e).setAttribute(a,v);}     // set value by id
        function f_ms2min(ms){
            const minutes = Math.floor(ms/60000);
            const tenths  = Math.round(((ms/60000)-minutes)*10)/10;
            return(minutes+tenths);
        }
        function f_redirect(where) {window.location.href = "/" + where;}
        // need to allow json updates unless +5 mins or -5min have been pressed
        function f_fanTimer(){
            let who = arguments[0];
            let value = Number(arguments[1]);
            const doc = document.getElementById("fanOnMs");
            if(who == "ws" && doc.getAttribute("updated") == "1")return;
            if(who == "ws"){doc.innerHTML=Number(value);return;}
            else doc.setAttribute("updated", "1");

            if(value === -1){
                jsn = {
                    json : fanOnMs
                  , fanOnMs : doc.innerHTML*60*1000
                };
                webSock.send(JSON.stringify(jsn));
                doc.setAttribute("updated", "0");
                document.getElementById("json1").innerHTML = JSON.stringify(jsn);
                return;
            }
            let val = Number(doc.innerHTML) + Number(value);
            if(val<0)val=0;
            doc.innerHTML = val;
    }
        function f_system() {
            let who = arguments[0];
            let value = Number(arguments[1]);

            const system = document.getElementById("system");
            let updated = system.getAttribute("updated");
            if(who=="ws" && updated=="1")return;
            if(who=="button"){
                value=!value;
                system.setAttribute("updated", "1");
            }
            system.style.backgroundColor = value ? "rgb(250, 0, 0)" : "rgb(0, 250, 0)";
            system.innerHTML = value ? "STOP" :"Enable" ;

            if(who=="button"){
                let jsn = {
                    json : systemEnabled
                  , systemEnabled : value?1:0
                };
                document.getElementById("json1").innerHTML = JSON.stringify(jsn);
                webSock.send(JSON.stringify(jsn));
                system.setAttribute("updated", "0");
            }
        }
        function f_battery(batt){
            let blink = document.getElementsByClassName("blink");
            for(i=0;i<blink.length;i++){
                if(batt<3.00)
                    blink[i].removeAttribute("hidden");
                else
                    blink[i].setAttribute("hidden", true);
            }
            document.getElementById("vcc").innerHTML = batt;
        }
        function f_fan(){
            fan = Number(arguments[0]);
            doc = document.getElementById("fanOn");
            doc.innerHTML = fan ? "ON" : "OFF";
            doc.style.color = fan?"white":"black";
            doc.style.backgroundColor = fan? "green":" rgb(248, 113, 135)";
        };
        let f_help = () => {
            if (document.getElementById("help").getAttribute("hidden")){
                document.getElementById("help").removeAttribute("hidden");
                document.getElementById("bt_help").value = "un-Help";
            }else{
                document.getElementById("help").setAttribute("hidden", true);
                document.getElementById("bt_help").value = "Help";
            }
        };
    </script>
</html>
